!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@antv/g-lite"),require("@antv/g-plugin-device-renderer")):"function"==typeof define&&define.amd?define(["exports","@antv/g-lite","@antv/g-plugin-device-renderer"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).G=e.G||{},e.G.WebGLDevice={}),e.window.G,e.window.G.DeviceRenderer)}(this,(function(e,t,r){"use strict";var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+t+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var a=function(){return a=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},a.apply(this,arguments)};function s(e,t,r,n){return new(r||(r=Promise))((function(i,a){function s(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,o)}l((n=n.apply(e,t||[])).next())}))}function o(e,t){var r,n,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&i[3]>o[1])){s.label=o[1];break}if(6===o[0]&&i[1]>s.label){s.label=i[1],i=o;break}if(i&&i[2]>s.label){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}function l(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return s}function u(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;a>i;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}var c={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}function i(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function a(e,t,n,a,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new i(n,a||e,s),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,n,i=[];if(0===this._eventsCount)return i;for(n in e=this._events)t.call(e,n)&&i.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=this._events[r?r+e:e];if(!t)return[];if(t.fn)return[t.fn];for(var n=0,i=t.length,a=Array(i);i>n;n++)a[n]=t[n].fn;return a},o.prototype.listenerCount=function(e){var t=this._events[r?r+e:e];return t?t.fn?1:t.length:0},o.prototype.emit=function(e,t,n,i,a,s){var o=r?r+e:e;if(!this._events[o])return!1;var l,u,c=this._events[o],h=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,i),!0;case 5:return c.fn.call(c.context,t,n,i,a),!0;case 6:return c.fn.call(c.context,t,n,i,a,s),!0}for(u=1,l=Array(h-1);h>u;u++)l[u-1]=arguments[u];c.fn.apply(c.context,l)}else{var p,d=c.length;for(u=0;d>u;u++)switch(c[u].once&&this.removeListener(e,c[u].fn,void 0,!0),h){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,t);break;case 3:c[u].fn.call(c[u].context,t,n);break;case 4:c[u].fn.call(c[u].context,t,n,i);break;default:if(!l)for(p=1,l=Array(h-1);h>p;p++)l[p-1]=arguments[p];c[u].fn.apply(c[u].context,l)}}return!0},o.prototype.on=function(e,t,r){return a(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return a(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,n,i){var a=r?r+e:e;if(!this._events[a])return this;if(!t)return s(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||i&&!o.once||n&&o.context!==n||s(this,a);else{for(var l=0,u=[],c=o.length;c>l;l++)(o[l].fn!==t||i&&!o[l].once||n&&o[l].context!==n)&&u.push(o[l]);u.length?this._events[a]=1===u.length?u[0]:u:s(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?this._events[t=r?r+e:e]&&s(this,t):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o}(c);var h=function(e){function t(t){var r=t.id,n=t.device,i=e.call(this)||this;return i.id=r,i.device=n,null!==i.device.resourceCreationTracker&&i.device.resourceCreationTracker.trackResourceCreated(i),i}return i(t,e),t.prototype.destroy=function(){null!==this.device.resourceCreationTracker&&this.device.resourceCreationTracker.trackResourceDestroyed(this)},t}(c.exports),p=function(e){function t(t){var n=t.descriptor,i=e.call(this,{id:t.id,device:t.device})||this;i.type=r.ResourceType.Bindings;var a=n.bindingLayout,s=n.uniformBufferBindings,o=n.samplerBindings;r.assert(s.length>=a.numUniformBuffers),r.assert(o.length>=a.numSamplers);for(var l=0;a.numUniformBuffers>l;l++)r.assert(s[l].wordCount>0);return i.uniformBufferBindings=n.uniformBufferBindings,i.samplerBindings=n.samplerBindings,i}return i(t,e),t}(h),d=function(e){return null==e},f={}.toString,m=function(e,t){return f.call(e)==="[object "+t+"]"},_=function(e,t,r){return t>e?t:e>r?r:e},g=function(e){return m(e,"Number")};function E(e){return"undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||!(!e||2!==e._version)}function F(e){if(r.getFormatFlags(e)&r.FormatFlags.Normalized)return!1;var t=r.getFormatTypeFlags(e);return t===r.FormatTypeFlags.S8||t===r.FormatTypeFlags.S16||t===r.FormatTypeFlags.S32||(t===r.FormatTypeFlags.U8||t===r.FormatTypeFlags.U16||t===r.FormatTypeFlags.U32)}function R(e){return e&r.BufferUsage.INDEX?r.GL.ELEMENT_ARRAY_BUFFER:e&r.BufferUsage.VERTEX?r.GL.ARRAY_BUFFER:e&r.BufferUsage.UNIFORM?r.GL.UNIFORM_BUFFER:void 0}function T(e){var t=r.getFormatTypeFlags(e),n=r.getFormatCompFlags(e),i=r.getFormatFlags(e),a=function(e){switch(e){case r.FormatTypeFlags.U8:return r.GL.UNSIGNED_BYTE;case r.FormatTypeFlags.U16:return r.GL.UNSIGNED_SHORT;case r.FormatTypeFlags.U32:return r.GL.UNSIGNED_INT;case r.FormatTypeFlags.S8:return r.GL.BYTE;case r.FormatTypeFlags.S16:return r.GL.SHORT;case r.FormatTypeFlags.S32:return r.GL.INT;case r.FormatTypeFlags.F16:return r.GL.HALF_FLOAT;case r.FormatTypeFlags.F32:return r.GL.FLOAT;default:throw Error("whoops")}}(t),s=function(e){switch(e){case r.FormatCompFlags.R:return 1;case r.FormatCompFlags.RG:return 2;case r.FormatCompFlags.RGB:return 3;case r.FormatCompFlags.RGBA:return 4;default:return 1}}(n);return{size:s,type:a,normalized:!!(i&r.FormatFlags.Normalized)}}function S(e){switch(e){case r.WrapMode.Clamp:return r.GL.CLAMP_TO_EDGE;case r.WrapMode.Repeat:return r.GL.REPEAT;case r.WrapMode.Mirror:return r.GL.MIRRORED_REPEAT;default:throw Error("whoops")}}function b(e,t){if(t===r.MipFilterMode.Linear&&e===r.TexFilterMode.Bilinear)return r.GL.LINEAR_MIPMAP_LINEAR;if(t===r.MipFilterMode.Linear&&e===r.TexFilterMode.Point)return r.GL.NEAREST_MIPMAP_LINEAR;if(t===r.MipFilterMode.Nearest&&e===r.TexFilterMode.Bilinear)return r.GL.LINEAR_MIPMAP_NEAREST;if(t===r.MipFilterMode.Nearest&&e===r.TexFilterMode.Point)return r.GL.NEAREST_MIPMAP_NEAREST;if(t===r.MipFilterMode.NoMip&&e===r.TexFilterMode.Bilinear)return r.GL.LINEAR;if(t===r.MipFilterMode.NoMip&&e===r.TexFilterMode.Point)return r.GL.NEAREST;throw Error("Unknown texture filter mode")}function v(e,t){void 0===t&&(t=0);return e.gl_buffer_pages[t/e.pageByteSize|0]}function y(e){return e.gl_texture}function B(e){return e.gl_sampler}function A(e,t){e.name=t,e.__SPECTOR_Metadata={name:t}}function L(e,t){for(var r=[];;){var n=t.exec(e);if(!n)break;r.push(n)}return r}function x(e){return e.blendMode==r.BlendMode.Add&&e.blendSrcFactor==r.BlendFactor.One&&e.blendDstFactor===r.BlendFactor.Zero}function G(e){if(e===r.TextureDimension.n2D)return r.GL.TEXTURE_2D;if(e===r.TextureDimension.n2DArray)return r.GL.TEXTURE_2D_ARRAY;if(e===r.TextureDimension.Cube)return r.GL.TEXTURE_CUBE_MAP;if(e===r.TextureDimension.n3D)return r.GL.TEXTURE_3D;throw Error("whoops")}function C(e,t,r,n){return e%r==0&&t%n==0}var D,M=function(e){function t(t){var n=t.device,i=t.descriptor,a=e.call(this,{id:t.id,device:n})||this;a.type=r.ResourceType.Buffer;var s=i.viewOrSize,o=i.usage,l=i.hint,u=n.uniformBufferMaxPageByteSize,c=n.gl;if(o&r.BufferUsage.STORAGE)return a;var h=o&r.BufferUsage.UNIFORM;h||(E(c)?c.bindVertexArray(null):n.OES_vertex_array_object.bindVertexArrayOES(null));var p,d=g(s)?r.align(s,4):r.align(s.byteLength,4);if(a.gl_buffer_pages=[],h){r.assert(d%u==0);for(var f=d;f>0;)a.gl_buffer_pages.push(a.createBufferPage(Math.min(f,u),o,l)),f-=u;p=u}else a.gl_buffer_pages.push(a.createBufferPage(d,o,l)),p=d;return a.pageByteSize=p,a.byteSize=d,a.usage=o,a.gl_target=R(o),h||(E(c)?c.bindVertexArray(a.device.currentBoundVAO):n.OES_vertex_array_object.bindVertexArrayOES(a.device.currentBoundVAO)),a}return i(t,e),t.prototype.setSubData=function(e,t,r,n){void 0===r&&(r=0),void 0===n&&(n=t.byteLength-r);var i=this.device.gl,a=this,s=a.gl_target,o=a.byteSize,l=a.pageByteSize;if(E(i)&&s===i.UNIFORM_BUFFER){if(e%l!=0)throw Error("Assert fail: (dstByteOffset [".concat(e,"] % dstPageByteSize [").concat(l,"]) === 0"));if(n%l!=0)throw Error("Assert fail: (byteSize [".concat(n,"] % dstPageByteSize [").concat(l,"]) === 0"))}if(o<e+n)throw Error("Assert fail: (dstByteOffset [".concat(e,"] + byteSize [").concat(n,"]) <= dstByteSize [").concat(o,"], gl_target ").concat(s));for(var u=e+n,c=e,h=e%l;u>c;){var p=E(i)?i.COPY_WRITE_BUFFER:this.gl_target;i.bindBuffer(p,v(this,c)),E(i)?i.bufferSubData(p,h,t,r,Math.min(u-c,l)):i.bufferSubData(p,h,t),c+=l,h=0,r+=l,this.device.debugGroupStatisticsBufferUpload()}},t.prototype.destroy=function(){e.prototype.destroy.call(this);for(var t=0;this.gl_buffer_pages.length>t;t++)this.gl_buffer_pages[t].ubo||this.device.gl.deleteBuffer(this.gl_buffer_pages[t])},t.prototype.createBufferPage=function(e,t,n){var i=this.device.gl,a=t&r.BufferUsage.UNIFORM;if(!E(i)&&a)return{ubo:!0};var s=this.device.ensureResourceExists(i.createBuffer()),o=R(t),l=function(e){switch(e){case r.BufferFrequencyHint.Static:return r.GL.STATIC_DRAW;case r.BufferFrequencyHint.Dynamic:return r.GL.DYNAMIC_DRAW}}(n);return i.bindBuffer(o,s),i.bufferData(o,e,l),s},t}(h),P=function(e){function t(t){var n=t.descriptor,i=e.call(this,{id:t.id,device:t.device})||this;i.type=r.ResourceType.InputLayout;var a=n.vertexAttributeDescriptors,s=n.vertexBufferDescriptors,o=n.indexBufferFormat;return r.assert(o===r.Format.U16_R||o===r.Format.U32_R||null===o),i.vertexAttributeDescriptors=a,i.vertexBufferDescriptors=s,i.indexBufferFormat=o,i}return i(t,e),t}(h),U=function(e){function t(t){var n,i=t.device,a=t.inputLayout,s=t.vertexBuffers,o=t.indexBufferBinding,l=t.program,u=this;(u=e.call(this,{id:t.id,device:i})||this).type=r.ResourceType.InputState;var c=u.device.gl,h=u.device.ensureResourceExists(E(c)?c.createVertexArray():i.OES_vertex_array_object.createVertexArrayOES());E(c)?c.bindVertexArray(h):i.OES_vertex_array_object.bindVertexArrayOES(h),i.currentBoundVAO=h;for(var p=0;a.vertexAttributeDescriptors.length>p;p++){var f=a.vertexAttributeDescriptors[p],m=f.format,_=f.divisor,g=void 0===_?1:_,R=f.byteStride,S=f.bufferByteOffset,b=f.bufferIndex,y=E(c)?f.location:null===(n=l.attributes[f.location])||void 0===n?void 0:n.location;if(!d(y)){F(m);var B=T(m),A=B.size,L=B.type,x=B.normalized,G=s[b];if(null===G)continue;var C=r.assertExists(a.vertexBufferDescriptors[b]);r.assert(!!(G.buffer.usage&r.BufferUsage.VERTEX)),c.bindBuffer(c.ARRAY_BUFFER,v(G.buffer)),c.vertexAttribPointer(y,A,L,x,R||C.byteStride,G.byteOffset+S),C.frequency===r.VertexBufferFrequency.PerInstance&&(E(c)?c.vertexAttribDivisor(y,g):i.ANGLE_instanced_arrays.vertexAttribDivisorANGLE(y,g)),c.enableVertexAttribArray(y)}}var D=null,M=null,P=null;null!==o&&(r.assert(!!(o.buffer.usage&r.BufferUsage.INDEX)),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,v(o.buffer)),D=function(e){switch(e){case r.Format.U8_R:return r.GL.UNSIGNED_BYTE;case r.Format.U16_R:return r.GL.UNSIGNED_SHORT;case r.Format.U32_R:return r.GL.UNSIGNED_INT;default:throw Error("whoops")}}(r.assertExists(a.indexBufferFormat)),M=r.getFormatCompByteSize(a.indexBufferFormat),P=o.byteOffset);return E(c)?c.bindVertexArray(null):i.OES_vertex_array_object.bindVertexArrayOES(null),i.currentBoundVAO=null,u.vao=h,u.indexBufferByteOffset=P,u.indexBufferType=D,u.indexBufferCompByteSize=M,u.inputLayout=a,u.vertexBuffers=s,u}return i(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.device.currentBoundVAO===this.vao&&(E(this.device.gl)?(this.device.gl.bindVertexArray(null),this.device.gl.deleteVertexArray(this.vao)):(this.device.OES_vertex_array_object.bindVertexArrayOES(null),this.device.OES_vertex_array_object.deleteVertexArrayOES(this.vao)),this.device.currentBoundVAO=null)},t}(h),O=function(e){function t(t){var n=t.device,i=t.descriptor,a=t.fake,s=e.call(this,{id:t.id,device:n})||this;s.type=r.ResourceType.Texture;var o,l,u=s.device.gl,c=s.clampNumLevels(i);if(s.immutable=!!i.immutable,s.pixelStore=i.pixelStore,s.pixelFormat=i.pixelFormat,s.formatKind=r.getFormatSamplerKind(i.pixelFormat),s.width=i.width,s.height=i.height,s.depth=i.depth,s.mipmaps=c>=1,!a){l=s.device.ensureResourceExists(u.createTexture());var h=s.device.translateTextureType(i.pixelFormat),p=s.device.translateTextureInternalFormat(i.pixelFormat);if(s.device.setActiveTexture(u.TEXTURE0),s.device.currentTextures[0]=null,s.preprocessImage(),i.dimension===r.TextureDimension.n2D){if(u.bindTexture(o=r.GL.TEXTURE_2D,l),s.immutable)if(E(u))u.texStorage2D(o,c,p,i.width,i.height);else{var d=(p===r.GL.DEPTH_COMPONENT||s.isNPOT(),0);(s.pixelFormat!==r.Format.D32F&&s.pixelFormat!==r.Format.D24_S8||E(u)||n.WEBGL_depth_texture)&&(u.texImage2D(o,d,p,i.width,i.height,0,p,h,null),s.mipmaps&&s.isNPOT()&&(s.mipmaps=!1,u.texParameteri(r.GL.TEXTURE_2D,r.GL.TEXTURE_MIN_FILTER,r.GL.LINEAR),u.texParameteri(r.GL.TEXTURE_2D,r.GL.TEXTURE_WRAP_S,r.GL.CLAMP_TO_EDGE),u.texParameteri(r.GL.TEXTURE_2D,r.GL.TEXTURE_WRAP_T,r.GL.CLAMP_TO_EDGE)))}r.assert(1===i.depth)}else if(i.dimension===r.TextureDimension.n2DArray)u.bindTexture(o=r.GL.TEXTURE_2D_ARRAY,l),E(u)&&u.texStorage3D(o,c,p,i.width,i.height,i.depth);else if(i.dimension===r.TextureDimension.n3D)u.bindTexture(o=r.GL.TEXTURE_3D,l),E(u)&&u.texStorage3D(o,c,p,i.width,i.height,i.depth);else{if(i.dimension!==r.TextureDimension.Cube)throw Error("whoops");u.bindTexture(o=r.GL.TEXTURE_CUBE_MAP,l),E(u)&&u.texStorage2D(o,c,p,i.width,i.height),r.assert(6===i.depth)}}return s.gl_texture=l,s.gl_target=o,s.numLevels=c,s}return i(t,e),t.prototype.setImageData=function(e,t){var r,n,i=this.device.gl,a=Array.isArray(e);this.device.setActiveTexture(i.TEXTURE0),this.device.currentTextures[0]=null,a?(r=this.width,n=this.height):(n=e.height,this.width=r=e.width,this.height=n),i.bindTexture(this.gl_target,this.gl_texture);var s=this.device.translateTextureFormat(this.pixelFormat),o=this.device.translateTextureType(this.pixelFormat);this.preprocessImage(),this.immutable?i.texSubImage2D(this.gl_target,0,0,0,r,n,s,o,a?e[0]:e):E(i)?i.texImage2D(this.gl_target,0,s,r,n,0,s,o,a?e[0]:e):a?i.texImage2D(this.gl_target,0,s,r,n,0,s,o,e[0]):i.texImage2D(this.gl_target,0,s,s,o,e),this.mipmaps&&this.generateMipmap()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.device.gl.deleteTexture(y(this))},t.prototype.clampNumLevels=function(e){if(e.dimension===r.TextureDimension.n2DArray&&e.depth>1&&r.getFormatTypeFlags(e.pixelFormat)===r.FormatTypeFlags.BC1)for(var t=e.width,n=e.height,i=0;e.numLevels>i;i++){if(2>=t||2>=n)return i-1;t=Math.max(t/2|0,1),n=Math.max(n/2|0,1)}return e.numLevels},t.prototype.preprocessImage=function(){var e=this.device.gl;this.pixelStore&&(this.pixelStore.unpackFlipY&&e.pixelStorei(r.GL.UNPACK_FLIP_Y_WEBGL,!0),this.pixelStore.packAlignment&&e.pixelStorei(r.GL.PACK_ALIGNMENT,this.pixelStore.packAlignment),this.pixelStore.unpackAlignment&&e.pixelStorei(r.GL.UNPACK_ALIGNMENT,this.pixelStore.unpackAlignment))},t.prototype.generateMipmap=function(){var e=this.device.gl;return!E(e)&&this.isNPOT()||this.gl_texture&&this.gl_target&&(e.bindTexture(this.gl_target,this.gl_texture),e.generateMipmap(this.gl_target),e.texParameteri(r.GL.TEXTURE_2D,r.GL.TEXTURE_MIN_FILTER,r.GL.NEAREST_MIPMAP_LINEAR),e.bindTexture(this.gl_target,null)),this},t.prototype.isNPOT=function(){return!E(this.device.gl)&&(!r.isPowerOfTwo(this.width)||!r.isPowerOfTwo(this.height))},t}(h);!function(e){e[e.NeedsCompile=0]="NeedsCompile",e[e.Compiling=1]="Compiling",e[e.NeedsBind=2]="NeedsBind",e[e.ReadyToUse=3]="ReadyToUse"}(D||(D={}));var N=function(e){function t(t){var n=t.descriptor,i=e.call(this,{id:t.id,device:t.device})||this;i.type=r.ResourceType.Program,i.uniformSetters={},i.attributes=[];var a=i.device.gl;return i.descriptor=n,i.gl_program=i.device.ensureResourceExists(a.createProgram()),i.gl_shader_vert=null,i.gl_shader_frag=null,i.compileState=D.NeedsCompile,i.tryCompileProgram(),i}return i(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.device.gl.deleteProgram(this.gl_program),this.device.gl.deleteShader(this.gl_shader_vert),this.device.gl.deleteShader(this.gl_shader_frag)},t.prototype.tryCompileProgram=function(){r.assert(this.compileState===D.NeedsCompile);var e=this.descriptor,t=this.device.gl;null!==this.gl_shader_vert&&t.deleteShader(this.gl_shader_vert),null!==this.gl_shader_frag&&t.deleteShader(this.gl_shader_frag),e.preprocessedCompute?(this.gl_shader_vert=this.compileShader(r.preprocessShader_GLSL(this.device.queryVendorInfo(),"vert","\nlayout(location = 0) in vec2 a_Position;\n\nout vec2 v_TexCoord;\n\nvoid main() {\n  v_TexCoord = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n\n  #ifdef VIEWPORT_ORIGIN_TL\n    v_TexCoord.y = 1.0 - v_TexCoord.y;\n  #endif\n}\n"),t.VERTEX_SHADER),this.gl_shader_frag=this.compileShader(e.preprocessedCompute,t.FRAGMENT_SHADER)):(this.gl_shader_vert=this.compileShader(e.preprocessedVert,t.VERTEX_SHADER),this.gl_shader_frag=this.compileShader(e.preprocessedFrag,t.FRAGMENT_SHADER)),t.attachShader(this.gl_program,this.gl_shader_vert),t.attachShader(this.gl_program,this.gl_shader_frag),t.linkProgram(this.gl_program),this.compileState=D.Compiling,E(t)||(this.readUniformLocationsFromLinkedProgram(),this.readAttributesFromLinkedProgram())},t.prototype.readAttributesFromLinkedProgram=function(){for(var e,t=this.device.gl,n=t.getProgramParameter(this.gl_program,t.ACTIVE_ATTRIBUTES),i=r.getDefines(this.descriptor.preprocessedVert),a=r.getAttributeLocations(this.descriptor.vert,i),s=function(r){var n=t.getActiveAttrib(o.gl_program,r),i=n.name,s=n.type,l=n.size,u=t.getAttribLocation(o.gl_program,i),c=null===(e=a.find((function(e){return e.name===i})))||void 0===e?void 0:e.location;0>u||d(c)||(o.attributes[c]={name:i,location:u,type:s,size:l})},o=this,l=0;n>l;l++)s(l)},t.prototype.readUniformLocationsFromLinkedProgram=function(){for(var e=this.device.gl,t=e.getProgramParameter(this.gl_program,e.ACTIVE_UNIFORMS),n=0;t>n;n++){var i=e.getActiveUniform(this.gl_program,n),a=r.parseUniformName(i.name).name,s=e.getUniformLocation(this.gl_program,a);if(this.uniformSetters[a]=r.getUniformSetter(e,s,i),i&&i.size>1)for(var o=0;i.size>o;o++)s=e.getUniformLocation(this.gl_program,"".concat(a,"[").concat(o,"]")),this.uniformSetters["".concat(a,"[").concat(o,"]")]=r.getUniformSetter(e,s,i)}},t.prototype.compileShader=function(e,t){var r=this.device.gl,n=this.device.ensureResourceExists(r.createShader(t));return r.shaderSource(n,e),r.compileShader(n),n},t.prototype.setUniforms=function(e){void 0===e&&(e={});var t=this.device.gl;if(!E(t)){var r=!1;for(var n in e){r||(t.useProgram(this.gl_program),r=!0);var i=this.uniformSetters[n];if(i){var a=e[n];a instanceof O&&(a=a.textureIndex),i(a)}}}return this},t}(h),I=function(e){function t(t){var n=t.descriptor,i=e.call(this,{id:t.id,device:t.device})||this;i.type=r.ResourceType.QueryPool;var a=i.device.gl;if(E(a)){var s=n.type;i.gl_query=r.nArray(n.elemCount,(function(){return i.device.ensureResourceExists(a.createQuery())})),i.gl_query_type=function(e){if(e===r.QueryPoolType.OcclusionConservative)return r.GL.ANY_SAMPLES_PASSED_CONSERVATIVE;throw Error("whoops")}(s)}return i}return i(t,e),t.prototype.queryResultOcclusion=function(e){var t=this.device.gl;if(E(t)){var r=this.gl_query[e];return t.getQueryParameter(r,t.QUERY_RESULT_AVAILABLE)?!!t.getQueryParameter(r,t.QUERY_RESULT):null}return null},t.prototype.destroy=function(){e.prototype.destroy.call(this);var t=this.device.gl;if(E(t))for(var r=0;this.gl_query.length>r;r++)t.deleteQuery(this.gl_query[r])},t}(h),w=function(e){function t(t){var n=e.call(this,{id:t.id,device:t.device})||this;return n.type=r.ResourceType.Readback,n.gl_pbo=null,n.gl_sync=null,n}return i(t,e),t.prototype.clientWaitAsync=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=10);var n=this.device.gl;return new Promise((function(i,a){!function s(){var o=n.clientWaitSync(e,t,0);o!=n.WAIT_FAILED?o!=n.TIMEOUT_EXPIRED?i():setTimeout(s,_(r,0,n.MAX_CLIENT_WAIT_TIMEOUT_WEBGL)):a()}()}))},t.prototype.getBufferSubDataAsync=function(e,t,r,n,i,a){return void 0===i&&(i=0),void 0===a&&(a=n.byteLength||0),s(this,void 0,void 0,(function(){var s;return o(this,(function(o){switch(o.label){case 0:return E(s=this.device.gl)?(this.gl_sync=s.fenceSync(s.SYNC_GPU_COMMANDS_COMPLETE,0),s.flush(),[4,this.clientWaitAsync(this.gl_sync,0,10)]):[3,2];case 1:return o.sent(),s.bindBuffer(e,t),s.getBufferSubData(e,r,n,i,a),s.bindBuffer(e,null),[2,n];case 2:return[2]}}))}))},t.prototype.readTexture=function(e,t,n,i,a,l,u,c){return void 0===u&&(u=0),void 0===c&&(c=l.byteLength||0),s(this,void 0,void 0,(function(){var s,h,p,d,f;return o(this,(function(o){return s=this.device.gl,p=this.device.translateTextureFormat((h=e).pixelFormat),d=this.device.translateTextureType(h.pixelFormat),f=r.getFormatByteSize(h.pixelFormat),E(s)?(this.gl_pbo=this.device.ensureResourceExists(s.createBuffer()),s.bindBuffer(s.PIXEL_PACK_BUFFER,this.gl_pbo),s.bufferData(s.PIXEL_PACK_BUFFER,c,s.STREAM_READ),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),s.bindFramebuffer(r.GL.READ_FRAMEBUFFER,this.device.readbackFramebuffer),s.framebufferTexture2D(r.GL.READ_FRAMEBUFFER,r.GL.COLOR_ATTACHMENT0,r.GL.TEXTURE_2D,h.gl_texture,0),s.bindBuffer(s.PIXEL_PACK_BUFFER,this.gl_pbo),s.readPixels(t,n,i,a,p,d,u*f),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),[2,this.getBufferSubDataAsync(s.PIXEL_PACK_BUFFER,this.gl_pbo,0,l,u,c)]):(s.bindFramebuffer(r.GL.FRAMEBUFFER,this.device.readbackFramebuffer),s.framebufferTexture2D(r.GL.FRAMEBUFFER,r.GL.COLOR_ATTACHMENT0,r.GL.TEXTURE_2D,h.gl_texture,0),s.pixelStorei(s.PACK_ALIGNMENT,4),s.readPixels(t,n,i,a,s.RGBA,d,l),[2,l])}))}))},t.prototype.readTextureSync=function(e,t,n,i,a,s,o,l){void 0===l&&(l=s.byteLength||0);var u=this.device.gl,c=e,h=this.device.translateTextureType(c.pixelFormat);return u.bindFramebuffer(r.GL.FRAMEBUFFER,this.device.readbackFramebuffer),u.framebufferTexture2D(r.GL.FRAMEBUFFER,r.GL.COLOR_ATTACHMENT0,r.GL.TEXTURE_2D,c.gl_texture,0),u.pixelStorei(u.PACK_ALIGNMENT,4),u.readPixels(t,n,i,a,u.RGBA,h,s),s},t.prototype.readBuffer=function(e,t,r,n,i){return s(this,void 0,void 0,(function(){var a;return o(this,(function(s){return E(a=this.device.gl)?[2,this.getBufferSubDataAsync(a.ARRAY_BUFFER,v(e,t),t,r,n,i)]:[2,Promise.reject()]}))}))},t.prototype.destroy=function(){e.prototype.destroy.call(this),E(this.device.gl)&&(null!==this.gl_sync&&this.device.gl.deleteSync(this.gl_sync),null!==this.gl_pbo&&this.device.gl.deleteBuffer(this.gl_pbo))},t}(h),k=function(e){function t(t){var n=t.descriptor,i=e.call(this,{id:t.id,device:t.device})||this;return i.type=r.ResourceType.RenderPipeline,i.bindingLayouts=i.createBindingLayouts(n.bindingLayouts),i.drawMode=function(e){switch(e){case r.PrimitiveTopology.Triangles:return r.GL.TRIANGLES;case r.PrimitiveTopology.Points:return r.GL.POINTS;case r.PrimitiveTopology.TriangleStrip:return r.GL.TRIANGLE_STRIP;case r.PrimitiveTopology.Lines:return r.GL.LINES;case r.PrimitiveTopology.LineStrip:return r.GL.LINE_STRIP;default:throw Error("Unknown primitive topology mode")}}(n.topology),i.program=n.program,i.inputLayout=n.inputLayout,i.megaState=n.megaStateDescriptor,i.colorAttachmentFormats=n.colorAttachmentFormats.slice(),i.depthStencilAttachmentFormat=n.depthStencilAttachmentFormat,i.sampleCount=n.sampleCount,i}return i(t,e),t.prototype.createBindingLayouts=function(e){for(var t=0,n=0,i=[],a=0;e.length>a;a++){var s=e[a],o=s.numUniformBuffers,l=s.numSamplers,u=s.samplerEntries,c=[];void 0!==u&&r.assert(u.length===l);for(var h=0;l>h;h++){var p=void 0!==u?u[h]:r.defaultBindingLayoutSamplerDescriptor,d=p.formatKind;c.push({gl_target:G(p.dimension),formatKind:d})}i.push({firstUniformBuffer:t,numUniformBuffers:o,firstSampler:n,numSamplers:l,samplerEntries:c}),t+=o,n+=l}return{numUniformBuffers:t,numSamplers:n,bindingLayoutTables:i}},t}(h),W=function(e){function t(t){var n=t.device,i=t.descriptor,a=e.call(this,{id:t.id,device:n})||this;a.type=r.ResourceType.RenderTarget,a.gl_renderbuffer=null,a.texture=null;var s=a.device.gl,o=i.pixelFormat,l=i.width,u=i.height,c=i.sampleCount,h=i.texture,p=!1;if(o!==r.Format.D32F&&o!==r.Format.D24_S8||!h||E(s)||n.WEBGL_depth_texture||(p=!0),!p&&h)a.texture=h;else{a.gl_renderbuffer=a.device.ensureResourceExists(s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,a.gl_renderbuffer);var d=a.device.translateTextureInternalFormat(o);E(s)?s.renderbufferStorageMultisample(r.GL.RENDERBUFFER,c,d,l,u):s.renderbufferStorage(r.GL.RENDERBUFFER,d,l,u)}return a.pixelFormat=o,a.width=l,a.height=u,a.sampleCount=c,a}return i(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),null!==this.gl_renderbuffer&&this.device.gl.deleteRenderbuffer(this.gl_renderbuffer)},t}(h),X=function(e){function t(t){var n=t.descriptor,i=e.call(this,{id:t.id,device:t.device})||this;return i.type=r.ResourceType.ComputePipeline,i.descriptor=n,i}return i(t,e),t}(h),H=function(){function e(){this.liveObjects=new Set,this.creationStacks=new Map,this.deletionStacks=new Map}return e.prototype.trackResourceCreated=function(e){this.creationStacks.set(e,Error().stack),this.liveObjects.add(e)},e.prototype.trackResourceDestroyed=function(e){this.deletionStacks.has(e)&&console.warn("Object double freed:",e,"\n\nCreation stack: ",this.creationStacks.get(e),"\n\nDeletion stack: ",this.deletionStacks.get(e),"\n\nThis stack: ",Error().stack),this.deletionStacks.set(e,Error().stack),this.liveObjects.delete(e)},e.prototype.checkForLeaks=function(){var e,t;try{for(var r=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(this.liveObjects.values()),n=r.next();!n.done;n=r.next()){var i=n.value;console.warn("Object leaked:",i,"Creation stack:",this.creationStacks.get(i))}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},e.prototype.setResourceLeakCheck=function(e,t){t?this.liveObjects.add(e):this.liveObjects.delete(e)},e}(),V=function(e){function t(t){var n,i,a=t.descriptor,s=this;(s=e.call(this,{id:t.id,device:t.device})||this).type=r.ResourceType.Sampler;var o=s.device.gl;if(E(o)){var l=s.device.ensureResourceExists(o.createSampler());o.samplerParameteri(l,r.GL.TEXTURE_WRAP_S,S(a.wrapS)),o.samplerParameteri(l,r.GL.TEXTURE_WRAP_T,S(a.wrapT)),o.samplerParameteri(l,r.GL.TEXTURE_WRAP_R,S(null!==(n=a.wrapQ)&&void 0!==n?n:a.wrapS)),o.samplerParameteri(l,r.GL.TEXTURE_MIN_FILTER,b(a.minFilter,a.mipFilter)),o.samplerParameteri(l,r.GL.TEXTURE_MAG_FILTER,b(a.magFilter,r.MipFilterMode.NoMip)),void 0!==a.minLOD&&o.samplerParameterf(l,r.GL.TEXTURE_MIN_LOD,a.minLOD),void 0!==a.maxLOD&&o.samplerParameterf(l,r.GL.TEXTURE_MAX_LOD,a.maxLOD),void 0!==a.compareMode&&(o.samplerParameteri(l,o.TEXTURE_COMPARE_MODE,o.COMPARE_REF_TO_TEXTURE),o.samplerParameteri(l,o.TEXTURE_COMPARE_FUNC,a.compareMode));var u=null!==(i=a.maxAnisotropy)&&void 0!==i?i:1;u>1&&null!==s.device.EXT_texture_filter_anisotropic&&(r.assert(a.minFilter===r.TexFilterMode.Bilinear&&a.magFilter===r.TexFilterMode.Bilinear&&a.mipFilter===r.MipFilterMode.Linear),o.samplerParameterf(l,s.device.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,u)),s.gl_sampler=l}else s.descriptor=a;return s}return i(t,e),t.prototype.setTextureParameters=function(e,t,n){var i,a=this.device.gl,s=this.descriptor;this.isNPOT(t,n)?a.texParameteri(r.GL.TEXTURE_2D,r.GL.TEXTURE_MIN_FILTER,r.GL.LINEAR):a.texParameteri(e,r.GL.TEXTURE_MIN_FILTER,b(s.minFilter,s.mipFilter)),a.texParameteri(r.GL.TEXTURE_2D,r.GL.TEXTURE_WRAP_S,S(s.wrapS)),a.texParameteri(r.GL.TEXTURE_2D,r.GL.TEXTURE_WRAP_T,S(s.wrapT)),a.texParameteri(e,r.GL.TEXTURE_MAG_FILTER,b(s.magFilter,r.MipFilterMode.NoMip));var o=null!==(i=s.maxAnisotropy)&&void 0!==i?i:1;o>1&&null!==this.device.EXT_texture_filter_anisotropic&&(r.assert(s.minFilter===r.TexFilterMode.Bilinear&&s.magFilter===r.TexFilterMode.Bilinear&&s.mipFilter===r.MipFilterMode.Linear),a.texParameteri(e,this.device.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,o))},t.prototype.destroy=function(){e.prototype.destroy.call(this),E(this.device.gl)&&this.device.gl.deleteSampler(B(this))},t.prototype.isNPOT=function(e,t){return!r.isPowerOfTwo(e)||!r.isPowerOfTwo(t)},t}(h),q=function(){function e(){}return e.prototype.dispatch=function(e,t,r){},e.prototype.finish=function(){},e.prototype.beginComputePass=function(){},e.prototype.setPipeline=function(e){},e.prototype.setBindings=function(e,t){},e}(),z=function(){function e(e,t){this.shaderDebug=!1,this.OES_vertex_array_object=null,this.ANGLE_instanced_arrays=null,this.OES_texture_float=null,this.OES_draw_buffers_indexed=null,this.WEBGL_depth_texture=null,this.WEBGL_compressed_texture_s3tc=null,this.WEBGL_compressed_texture_s3tc_srgb=null,this.EXT_texture_compression_rgtc=null,this.EXT_texture_filter_anisotropic=null,this.KHR_parallel_shader_compile=null,this.EXT_texture_norm16=null,this.OES_texture_float_linear=null,this.OES_texture_half_float_linear=null,this.scTexture=null,this.scPlatformFramebuffer=null,this.currentActiveTexture=null,this.currentBoundVAO=null,this.currentProgram=null,this.resourceCreationTracker=null,this.resourceUniqueId=0,this.currentColorAttachments=[],this.currentColorAttachmentLevels=[],this.currentColorResolveTos=[],this.currentColorResolveToLevels=[],this.currentDepthStencilResolveTo=null,this.currentSampleCount=-1,this.currentMegaState=r.copyMegaState(r.defaultMegaState),this.currentSamplers=[],this.currentTextures=[],this.currentUniformBuffers=[],this.currentUniformBufferByteOffsets=[],this.currentUniformBufferByteSizes=[],this.currentScissorEnabled=!1,this.currentStencilRef=null,this.currentRenderPassDescriptor=null,this.debugGroupStack=[],this.resolveColorAttachmentsChanged=!1,this.resolveDepthStencilAttachmentsChanged=!1,this.explicitBindingLocations=!1,this.separateSamplerTextures=!1,this.viewportOrigin=r.ViewportOrigin.LowerLeft,this.clipSpaceNearZ=r.ClipSpaceNearZ.NegativeOne,this.supportMRT=!1,this.inBlitRenderPass=!1,this.supportedSampleCounts=[],this.occlusionQueriesRecommended=!1,this.gl=e,this.contextAttributes=r.assertExists(e.getContextAttributes()),E(e)?this.EXT_texture_norm16=e.getExtension("EXT_texture_norm16"):(this.OES_vertex_array_object=e.getExtension("OES_vertex_array_object"),this.ANGLE_instanced_arrays=e.getExtension("ANGLE_instanced_arrays"),this.OES_texture_float=e.getExtension("OES_texture_float"),e.getExtension("EXT_frag_depth"),e.getExtension("OES_element_index_uint"),e.getExtension("OES_standard_derivatives")),this.WEBGL_compressed_texture_s3tc=e.getExtension("WEBGL_compressed_texture_s3tc"),this.WEBGL_compressed_texture_s3tc_srgb=e.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.EXT_texture_compression_rgtc=e.getExtension("EXT_texture_compression_rgtc"),this.EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic"),this.EXT_texture_norm16=e.getExtension("EXT_texture_norm16"),this.OES_texture_float_linear=e.getExtension("OES_texture_float_linear"),this.OES_texture_half_float_linear=e.getExtension("OES_texture_half_float_linear"),this.KHR_parallel_shader_compile=e.getExtension("KHR_parallel_shader_compile"),E(e)?(this.platformString="WebGL2",this.glslVersion="#version 300 es"):(this.platformString="WebGL1",this.glslVersion="#version 100"),this.scTexture=new O({id:this.getNextUniqueId(),device:this,descriptor:{width:0,height:0,depth:1,dimension:r.TextureDimension.n2D,numLevels:1,usage:r.TextureUsage.RenderTarget,pixelFormat:!1===this.contextAttributes.alpha?r.Format.U8_RGB_RT:r.Format.U8_RGBA_RT},fake:!0}),this.scTexture.formatKind=r.SamplerFormatKind.Float,this.scTexture.gl_target=null,this.scTexture.gl_texture=null,this.resolveColorReadFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.resolveColorDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.resolveDepthStencilReadFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.resolveDepthStencilDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.renderPassDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.readbackFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.fallbackTexture2D=this.createFallbackTexture(r.TextureDimension.n2D,r.SamplerFormatKind.Float),this.fallbackTexture2DDepth=this.createFallbackTexture(r.TextureDimension.n2D,r.SamplerFormatKind.Depth),E(e),this.currentMegaState.depthCompare=r.CompareMode.Less,this.currentMegaState.depthWrite=!1,this.currentMegaState.attachmentsState[0].channelWriteMask=r.ChannelWriteMask.AllChannels,e.enable(e.DEPTH_TEST),e.enable(e.STENCIL_TEST),this.checkLimits(),t.shaderDebug&&(this.shaderDebug=!0),t.trackResources&&(this.resourceCreationTracker=new H)}return e.prototype.createFallbackTexture=function(e,t){var n=e===r.TextureDimension.Cube?6:1,i=this.createTexture({dimension:e,pixelFormat:t===r.SamplerFormatKind.Depth?r.Format.D32F:r.Format.U8_RGBA_NORM,usage:r.TextureUsage.Sampled,width:1,height:1,depth:n,numLevels:1,immutable:!0});return t===r.SamplerFormatKind.Float&&i.setImageData([new Uint8Array(4*n)],0),y(i)},e.prototype.getNextUniqueId=function(){return++this.resourceUniqueId},e.prototype.checkLimits=function(){var e=this.gl;if(this.maxVertexAttribs=e.getParameter(r.GL.MAX_VERTEX_ATTRIBS),E(e)){this.uniformBufferMaxPageByteSize=Math.min(e.getParameter(r.GL.MAX_UNIFORM_BLOCK_SIZE),65536),this.uniformBufferWordAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT)/4;var t=e.getInternalformatParameter(e.RENDERBUFFER,e.DEPTH32F_STENCIL8,e.SAMPLES);this.supportedSampleCounts=t?u([],l(t),!1):[],this.occlusionQueriesRecommended=!0}else this.uniformBufferWordAlignment=64,this.uniformBufferMaxPageByteSize=65536;this.uniformBufferMaxPageWordSize=this.uniformBufferMaxPageByteSize/4,this.supportedSampleCounts.includes(1)||this.supportedSampleCounts.push(1),this.supportedSampleCounts.sort((function(e,t){return e-t}))},e.prototype.configureSwapChain=function(e,t,n){var i=this.scTexture;i.width=e,i.height=t,this.scPlatformFramebuffer=r.nullify(n)},e.prototype.getDevice=function(){return this},e.prototype.getCanvas=function(){return this.gl.canvas},e.prototype.getOnscreenTexture=function(){return this.scTexture},e.prototype.beginFrame=function(){},e.prototype.endFrame=function(){},e.prototype.translateTextureInternalFormat=function(e){switch(e){case r.Format.ALPHA:return r.GL.ALPHA;case r.Format.F16_R:return r.GL.R16F;case r.Format.F16_RG:return r.GL.RG16F;case r.Format.F16_RGB:return r.GL.RGB16F;case r.Format.F16_RGBA:return r.GL.RGBA16F;case r.Format.F32_R:return r.GL.R32F;case r.Format.F32_RG:return r.GL.RG32F;case r.Format.F32_RGB:return r.GL.RGB32F;case r.Format.F32_RGBA:return r.GL.RGBA32F;case r.Format.U8_R_NORM:return r.GL.R8;case r.Format.U8_RG_NORM:return r.GL.RG8;case r.Format.U8_RGB_NORM:case r.Format.U8_RGB_RT:return r.GL.RGB8;case r.Format.U8_RGB_SRGB:return r.GL.SRGB8;case r.Format.U8_RGBA_NORM:case r.Format.U8_RGBA_RT:return E(this.gl)?r.GL.RGBA8:r.GL.RGBA;case r.Format.U8_RGBA_SRGB:case r.Format.U8_RGBA_RT_SRGB:return r.GL.SRGB8_ALPHA8;case r.Format.U16_R:return r.GL.R16UI;case r.Format.U16_R_NORM:return this.EXT_texture_norm16.R16_EXT;case r.Format.U16_RG_NORM:return this.EXT_texture_norm16.RG16_EXT;case r.Format.U16_RGBA_NORM:return this.EXT_texture_norm16.RGBA16_EXT;case r.Format.U32_R:return r.GL.R32UI;case r.Format.S8_RGBA_NORM:return r.GL.RGBA8_SNORM;case r.Format.S8_RG_NORM:return r.GL.RG8_SNORM;case r.Format.U16_RGBA_5551:return r.GL.UNSIGNED_SHORT_5_5_5_1;case r.Format.BC1:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;case r.Format.BC1_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case r.Format.BC2:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;case r.Format.BC2_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case r.Format.BC3:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;case r.Format.BC3_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case r.Format.BC4_UNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_RED_RGTC1_EXT;case r.Format.BC4_SNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT;case r.Format.BC5_UNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT;case r.Format.BC5_SNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT;case r.Format.D32F_S8:return E(this.gl)?r.GL.DEPTH32F_STENCIL8:this.WEBGL_depth_texture?r.GL.DEPTH_STENCIL:r.GL.DEPTH_COMPONENT16;case r.Format.D24_S8:return E(this.gl)?r.GL.DEPTH24_STENCIL8:this.WEBGL_depth_texture?r.GL.DEPTH_STENCIL:r.GL.DEPTH_COMPONENT16;case r.Format.D32F:return E(this.gl)?r.GL.DEPTH_COMPONENT32F:this.WEBGL_depth_texture?r.GL.DEPTH_COMPONENT:r.GL.DEPTH_COMPONENT16;case r.Format.D24:return E(this.gl)?r.GL.DEPTH_COMPONENT24:this.WEBGL_depth_texture?r.GL.DEPTH_COMPONENT:r.GL.DEPTH_COMPONENT16;default:throw Error("whoops")}},e.prototype.translateTextureType=function(e){switch(r.getFormatTypeFlags(e)){case r.FormatTypeFlags.U8:return r.GL.UNSIGNED_BYTE;case r.FormatTypeFlags.U16:return r.GL.UNSIGNED_SHORT;case r.FormatTypeFlags.U32:return r.GL.UNSIGNED_INT;case r.FormatTypeFlags.S8:return r.GL.BYTE;case r.FormatTypeFlags.F16:return r.GL.HALF_FLOAT;case r.FormatTypeFlags.F32:return r.GL.FLOAT;case r.FormatTypeFlags.U16_PACKED_5551:return r.GL.UNSIGNED_SHORT_5_5_5_1;case r.FormatTypeFlags.D32F:return E(this.gl)?r.GL.FLOAT:this.WEBGL_depth_texture?r.GL.UNSIGNED_INT:r.GL.UNSIGNED_BYTE;case r.FormatTypeFlags.D24:return E(this.gl)?r.GL.UNSIGNED_INT_24_8:this.WEBGL_depth_texture?r.GL.UNSIGNED_SHORT:r.GL.UNSIGNED_BYTE;case r.FormatTypeFlags.D24S8:return E(this.gl)?r.GL.UNSIGNED_INT_24_8:this.WEBGL_depth_texture?r.GL.UNSIGNED_INT_24_8_WEBGL:r.GL.UNSIGNED_BYTE;case r.FormatTypeFlags.D32FS8:return r.GL.FLOAT_32_UNSIGNED_INT_24_8_REV;default:throw Error("whoops")}},e.prototype.translateTextureFormat=function(e){if(function(e){switch(r.getFormatTypeFlags(e)){case r.FormatTypeFlags.BC1:case r.FormatTypeFlags.BC2:case r.FormatTypeFlags.BC3:case r.FormatTypeFlags.BC4_UNORM:case r.FormatTypeFlags.BC4_SNORM:case r.FormatTypeFlags.BC5_UNORM:case r.FormatTypeFlags.BC5_SNORM:return!0;default:return!1}}(e))return this.translateTextureInternalFormat(e);var t=E(this.gl)||!E(this.gl)&&!!this.WEBGL_depth_texture;switch(e){case r.Format.D24_S8:case r.Format.D32F_S8:return t?r.GL.DEPTH_STENCIL:r.GL.RGBA;case r.Format.D24:case r.Format.D32F:return t?r.GL.DEPTH_COMPONENT:r.GL.RGBA}var n=F(e);switch(r.getFormatCompFlags(e)){case r.FormatCompFlags.A:return r.GL.ALPHA;case r.FormatCompFlags.R:return n?r.GL.RED_INTEGER:r.GL.RED;case r.FormatCompFlags.RG:return n?r.GL.RG_INTEGER:r.GL.RG;case r.FormatCompFlags.RGB:return n?r.GL.RGB_INTEGER:r.GL.RGB;case r.FormatCompFlags.RGBA:return r.GL.RGBA}},e.prototype.setActiveTexture=function(e){this.currentActiveTexture!==e&&(this.gl.activeTexture(e),this.currentActiveTexture=e)},e.prototype.bindVAO=function(e){this.currentBoundVAO!==e&&(E(this.gl)?this.gl.bindVertexArray(e):this.OES_vertex_array_object.bindVertexArrayOES(e),this.currentBoundVAO=e)},e.prototype.programCompiled=function(e){r.assert(e.compileState!==D.NeedsCompile),e.compileState===D.Compiling&&(e.compileState=D.NeedsBind,this.shaderDebug&&this.checkProgramCompilationForErrors(e))},e.prototype.useProgram=function(e){this.currentProgram!==e&&(this.programCompiled(e),this.gl.useProgram(e.gl_program),this.currentProgram=e)},e.prototype.ensureResourceExists=function(e){if(null===e){var t=this.gl.getError();throw Error("Created resource is null; GL error encountered: ".concat(t))}return e},e.prototype.createBuffer=function(e){return new M({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createTexture=function(e){return new O({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createSampler=function(e){return new V({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createRenderTarget=function(e){return new W({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createRenderTargetFromTexture=function(e){var t=e.pixelFormat,n=e.width,i=e.height;return r.assert(1===e.numLevels),this.createRenderTarget({pixelFormat:t,width:n,height:i,sampleCount:1,texture:e})},e.prototype.createProgram=function(e){return e.ensurePreprocessed(this.queryVendorInfo()),this.createProgramSimple(e)},e.prototype.createProgramSimple=function(e){return new N({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createBindings=function(e){return new p({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createInputLayout=function(e){return new P({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createInputState=function(e,t,r,n){var i=e;return new U({id:this.getNextUniqueId(),device:this,inputLayout:i,vertexBuffers:t,indexBufferBinding:r,program:n})},e.prototype.createRenderPipeline=function(e){return new k({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createComputePass=function(){return new q},e.prototype.createComputePipeline=function(e){return new X({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createReadback=function(){return new w({id:this.getNextUniqueId(),device:this})},e.prototype.createQueryPool=function(e,t){return new I({id:this.getNextUniqueId(),device:this,descriptor:{type:e,elemCount:t}})},e.prototype.createRenderPass=function(e){r.assert(null===this.currentRenderPassDescriptor),this.currentRenderPassDescriptor=e;var t=e.colorAttachment,n=e.colorAttachmentLevel,i=e.colorClearColor,a=e.colorResolveTo,s=e.colorResolveToLevel,o=e.depthStencilAttachment,l=e.depthClearValue,u=e.stencilClearValue,c=e.depthStencilResolveTo;this.setRenderPassParametersBegin(t.length);for(var h=0;t.length>h;h++)this.setRenderPassParametersColor(h,t[h],n[h],a[h],s[h]);this.setRenderPassParametersDepthStencil(o,c),this.validateCurrentAttachments();for(h=0;t.length>h;h++){var p=i[h];"load"!==p&&this.setRenderPassParametersClearColor(h,p.r,p.g,p.b,p.a)}return this.setRenderPassParametersClearDepthStencil(l,u),this},e.prototype.submitPass=function(e){r.assert(null!==this.currentRenderPassDescriptor),this.endPass(),this.currentRenderPassDescriptor=null},e.prototype.copySubTexture2D=function(e,t,n,i,a,s){var o=this.gl,l=e,u=i;r.assert(1===u.numLevels),r.assert(1===l.numLevels),E(o)&&(l===this.scTexture?o.bindFramebuffer(o.DRAW_FRAMEBUFFER,this.scPlatformFramebuffer):(o.bindFramebuffer(o.DRAW_FRAMEBUFFER,this.resolveColorDrawFramebuffer),this.bindFramebufferAttachment(o.DRAW_FRAMEBUFFER,o.COLOR_ATTACHMENT0,l,0)),o.bindFramebuffer(o.READ_FRAMEBUFFER,this.resolveColorReadFramebuffer),this.bindFramebufferAttachment(o.READ_FRAMEBUFFER,o.COLOR_ATTACHMENT0,u,0),o.blitFramebuffer(a,s,a+u.width,s+u.height,t,n,t+u.width,n+u.height,o.COLOR_BUFFER_BIT,o.LINEAR),o.bindFramebuffer(o.READ_FRAMEBUFFER,null),o.bindFramebuffer(o.DRAW_FRAMEBUFFER,null))},e.prototype.queryLimits=function(){return this},e.prototype.queryTextureFormatSupported=function(e,t,n){switch(e){case r.Format.BC1_SRGB:case r.Format.BC2_SRGB:case r.Format.BC3_SRGB:return null!==this.WEBGL_compressed_texture_s3tc_srgb&&C(t,n,4,4);case r.Format.BC1:case r.Format.BC2:case r.Format.BC3:return null!==this.WEBGL_compressed_texture_s3tc&&C(t,n,4,4);case r.Format.BC4_UNORM:case r.Format.BC4_SNORM:case r.Format.BC5_UNORM:case r.Format.BC5_SNORM:return null!==this.EXT_texture_compression_rgtc&&C(t,n,4,4);case r.Format.U16_R_NORM:case r.Format.U16_RG_NORM:case r.Format.U16_RGBA_NORM:return null!==this.EXT_texture_norm16;case r.Format.F32_R:case r.Format.F32_RG:case r.Format.F32_RGB:case r.Format.F32_RGBA:return null!==this.OES_texture_float_linear;case r.Format.F16_R:case r.Format.F16_RG:case r.Format.F16_RGB:case r.Format.F16_RGBA:return null!==this.OES_texture_half_float_linear;default:return!0}},e.prototype.queryProgramReady=function(e){var t=this.gl;if(e.compileState===D.NeedsCompile)throw Error("whoops");if(e.compileState===D.Compiling){var r=void 0;return(r=null===this.KHR_parallel_shader_compile||t.getProgramParameter(e.gl_program,this.KHR_parallel_shader_compile.COMPLETION_STATUS_KHR))&&this.programCompiled(e),r}return e.compileState===D.NeedsBind||e.compileState===D.ReadyToUse},e.prototype.queryPlatformAvailable=function(){return this.gl.isContextLost()},e.prototype.queryVendorInfo=function(){return this},e.prototype.queryRenderPass=function(e){return this.currentRenderPassDescriptor},e.prototype.queryRenderTarget=function(e){return e},e.prototype.setResourceName=function(e,t){if(e.name=t,e.type===r.ResourceType.Buffer)for(var n=e.gl_buffer_pages,i=0;n.length>i;i++)A(n[i],"".concat(t," Page ").concat(i));else if(e.type===r.ResourceType.Texture)A(y(e),t);else if(e.type===r.ResourceType.Sampler)A(B(e),t);else if(e.type===r.ResourceType.RenderTarget){var a=e.gl_renderbuffer;null!==a&&A(a,t)}else e.type===r.ResourceType.InputState&&A(e.vao,t)},e.prototype.setResourceLeakCheck=function(e,t){null!==this.resourceCreationTracker&&this.resourceCreationTracker.setResourceLeakCheck(e,t)},e.prototype.checkForLeaks=function(){null!==this.resourceCreationTracker&&this.resourceCreationTracker.checkForLeaks()},e.prototype.pushDebugGroup=function(e){this.debugGroupStack.push(e)},e.prototype.popDebugGroup=function(){this.debugGroupStack.pop()},e.prototype.programPatched=function(e,t){r.assert(this.shaderDebug)},e.prototype.getBufferData=function(e,t,r){void 0===r&&(r=0);var n=this.gl;E(n)&&(n.bindBuffer(n.COPY_READ_BUFFER,v(e,4*r)),n.getBufferSubData(n.COPY_READ_BUFFER,4*r,t))},e.prototype.debugGroupStatisticsDrawCall=function(e){void 0===e&&(e=1);for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].drawCallCount+=e},e.prototype.debugGroupStatisticsBufferUpload=function(e){void 0===e&&(e=1);for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].bufferUploadCount+=e},e.prototype.debugGroupStatisticsTextureBind=function(e){void 0===e&&(e=1);for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].textureBindCount+=e},e.prototype.debugGroupStatisticsTriangles=function(e){for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].triangleCount+=e},e.prototype.reportShaderError=function(e,t){var n=this.gl,i=n.getShaderParameter(e,n.COMPILE_STATUS);if(!i){console.error(r.prependLineNo(t));var a=n.getExtension("WEBGL_debug_shaders");a&&console.error(a.getTranslatedShaderSource(e)),console.error(n.getShaderInfoLog(e))}return i},e.prototype.checkProgramCompilationForErrors=function(e){var t=this.gl;if(!t.getProgramParameter(e.gl_program,t.LINK_STATUS)){var r=e.descriptor;if(!this.reportShaderError(e.gl_shader_vert,r.preprocessedVert))return;if(!this.reportShaderError(e.gl_shader_frag,r.preprocessedFrag))return;console.error(t.getProgramInfoLog(e.gl_program))}},e.prototype.bindFramebufferAttachment=function(e,t,n,i){var a=this.gl;null===n?a.framebufferRenderbuffer(e,t,a.RENDERBUFFER,null):n.type===r.ResourceType.RenderTarget?null!==n.gl_renderbuffer?a.framebufferRenderbuffer(e,t,a.RENDERBUFFER,n.gl_renderbuffer):null!==n.texture&&a.framebufferTexture2D(e,t,r.GL.TEXTURE_2D,y(n.texture),i):n.type===r.ResourceType.Texture&&a.framebufferTexture2D(e,t,r.GL.TEXTURE_2D,y(n),i)},e.prototype.bindFramebufferDepthStencilAttachment=function(e,t){var n=this.gl,i=null!==t?r.getFormatFlags(t.pixelFormat):r.FormatFlags.Depth|r.FormatFlags.Stencil,a=!!(i&r.FormatFlags.Depth),s=!!(i&r.FormatFlags.Stencil);if(a&&s){var o=E(this.gl)||!E(this.gl)&&!!this.WEBGL_depth_texture;this.bindFramebufferAttachment(e,o?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT,t,0)}else a?(this.bindFramebufferAttachment(e,n.DEPTH_ATTACHMENT,t,0),this.bindFramebufferAttachment(e,n.STENCIL_ATTACHMENT,null,0)):s&&(this.bindFramebufferAttachment(e,n.STENCIL_ATTACHMENT,t,0),this.bindFramebufferAttachment(e,n.DEPTH_ATTACHMENT,null,0))},e.prototype.validateCurrentAttachments=function(){for(var e=-1,t=-1,n=-1,i=0;this.currentColorAttachments.length>i;i++){var a=this.currentColorAttachments[i];null!==a&&(-1===e?(e=a.sampleCount,t=a.width,n=a.height):(r.assert(e===a.sampleCount),r.assert(t===a.width),r.assert(n===a.height)))}null!==this.currentDepthStencilAttachment&&(-1===e?(e=this.currentDepthStencilAttachment.sampleCount,t=this.currentDepthStencilAttachment.width,n=this.currentDepthStencilAttachment.height):(r.assert(e===this.currentDepthStencilAttachment.sampleCount),r.assert(t===this.currentDepthStencilAttachment.width),r.assert(n===this.currentDepthStencilAttachment.height))),this.currentSampleCount=e},e.prototype.setRenderPassParametersBegin=function(e){var t=this.gl;if(E(t)?t.bindFramebuffer(r.GL.DRAW_FRAMEBUFFER,this.renderPassDrawFramebuffer):this.inBlitRenderPass||t.bindFramebuffer(r.GL.FRAMEBUFFER,this.renderPassDrawFramebuffer),!this.inBlitRenderPass)for(var n=e;this.currentColorAttachments.length>n;n++){var i=E(t)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,a=E(t)?r.GL.COLOR_ATTACHMENT0:r.GL.COLOR_ATTACHMENT0_WEBGL;t.framebufferRenderbuffer(i,a+n,r.GL.RENDERBUFFER,null),t.framebufferTexture2D(i,a+n,r.GL.TEXTURE_2D,null,0)}this.currentColorAttachments.length=e},e.prototype.setRenderPassParametersColor=function(e,t,n,i,a){var s=this.gl;this.currentColorAttachments[e]===t&&this.currentColorAttachmentLevels[e]===n||(this.currentColorAttachments[e]=t,this.currentColorAttachmentLevels[e]=n,(E(s)||0===e)&&this.bindFramebufferAttachment(E(s)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,(E(s)?r.GL.COLOR_ATTACHMENT0:r.GL.COLOR_ATTACHMENT0_WEBGL)+e,t,n),this.resolveColorAttachmentsChanged=!0),this.currentColorResolveTos[e]===i&&this.currentColorResolveToLevels[e]===a||(this.currentColorResolveTos[e]=i,this.currentColorResolveToLevels[e]=a,null!==i&&(this.resolveColorAttachmentsChanged=!0))},e.prototype.setRenderPassParametersDepthStencil=function(e,t){var n=this.gl;this.currentDepthStencilAttachment!==e&&(this.currentDepthStencilAttachment=e,this.inBlitRenderPass||this.bindFramebufferDepthStencilAttachment(E(n)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,this.currentDepthStencilAttachment),this.resolveDepthStencilAttachmentsChanged=!0),this.currentDepthStencilResolveTo!==t&&(this.currentDepthStencilResolveTo=t,null!==t&&(this.resolveDepthStencilAttachmentsChanged=!0))},e.prototype.setRenderPassParametersClearColor=function(e,t,n,i,a){var s,o=this.gl;null!==this.OES_draw_buffers_indexed?(s=this.currentMegaState.attachmentsState[e])&&s.channelWriteMask!==r.ChannelWriteMask.AllChannels&&(this.OES_draw_buffers_indexed.colorMaskiOES(e,!0,!0,!0,!0),s.channelWriteMask=r.ChannelWriteMask.AllChannels):(s=this.currentMegaState.attachmentsState[0])&&s.channelWriteMask!==r.ChannelWriteMask.AllChannels&&(o.colorMask(!0,!0,!0,!0),s.channelWriteMask=r.ChannelWriteMask.AllChannels);this.setScissorEnabled(!1),E(o)?o.clearBufferfv(o.COLOR,e,[t,n,i,a]):(o.clearColor(t,n,i,a),o.clear(o.COLOR_BUFFER_BIT))},e.prototype.setRenderPassParametersClearDepthStencil=function(e,t){var n=this.gl;"load"!==e&&(r.assert(null!==this.currentDepthStencilAttachment),this.currentMegaState.depthWrite||(n.depthMask(!0),this.currentMegaState.depthWrite=!0),E(n)?n.clearBufferfv(n.DEPTH,0,[e]):(n.clearDepth(e),n.clear(n.DEPTH_BUFFER_BIT))),"load"!==t&&(r.assert(null!==this.currentDepthStencilAttachment),this.currentMegaState.stencilWrite||(n.enable(n.STENCIL_TEST),n.stencilMask(255),this.currentMegaState.stencilWrite=!0),E(n)?n.clearBufferiv(n.STENCIL,0,[t]):(n.clearStencil(t),n.clear(n.STENCIL_BUFFER_BIT)))},e.prototype.setBindings=function(e,t,n){var i,a=this.gl;r.assert(this.currentPipeline.bindingLayouts.bindingLayoutTables.length>e);var s=this.currentPipeline.bindingLayouts.bindingLayoutTables[e],o=t.uniformBufferBindings,l=t.samplerBindings;r.assert(o.length>=s.numUniformBuffers),r.assert(l.length>=s.numSamplers),r.assert(n.length>=o.length);for(var u=0;o.length>u;u++){if(0!==(_=o[u]).wordCount){var c=s.firstUniformBuffer+u,h=_.buffer,p=n[u],d=4*_.wordCount;if(h!==this.currentUniformBuffers[c]||p!==this.currentUniformBufferByteOffsets[c]||d!==this.currentUniformBufferByteSizes[c]){var f=p%h.pageByteSize,m=h.gl_buffer_pages[p/h.pageByteSize|0];r.assert(h.pageByteSize>=f+d),E(a)&&a.bindBufferRange(a.UNIFORM_BUFFER,c,m,f,d),this.currentUniformBuffers[c]=h,this.currentUniformBufferByteOffsets[c]=p,this.currentUniformBufferByteSizes[c]=d}}}for(u=0;s.numSamplers>u;u++){var _,g=s.firstSampler+u,F=s.samplerEntries[u],R=null!==(_=l[u])&&null!==_.sampler?B(_.sampler):null,T=null!==_&&null!==_.texture?y(_.texture):null;if(this.currentSamplers[g]!==R&&(E(a)&&a.bindSampler(g,R),this.currentSamplers[g]=R),this.currentTextures[g]!==T){if(this.setActiveTexture(a.TEXTURE0+g),null!==T){_.texture.textureIndex=g;var S=r.assertExists(_).texture,b=S.gl_target,v=S.width,A=S.height;a.bindTexture(b,T),E(a)||null===(i=_.sampler)||void 0===i||i.setTextureParameters(b,v,A),this.debugGroupStatisticsTextureBind(),r.assert(F.gl_target===b)}else a.bindTexture(F.gl_target,this.getFallbackTexture(F));this.currentTextures[g]=T}}},e.prototype.setViewport=function(e,t,r,n){this.gl.viewport(e,t,r,n)},e.prototype.setScissor=function(e,t,r,n){var i=this.gl;this.setScissorEnabled(!0),i.scissor(e,t,r,n)},e.prototype.applyAttachmentStateIndexed=function(e,t,n){var i=this.gl,a=this.OES_draw_buffers_indexed;t.channelWriteMask!==n.channelWriteMask&&(a.colorMaskiOES(e,!!(n.channelWriteMask&r.ChannelWriteMask.Red),!!(n.channelWriteMask&r.ChannelWriteMask.Green),!!(n.channelWriteMask&r.ChannelWriteMask.Blue),!!(n.channelWriteMask&r.ChannelWriteMask.Alpha)),t.channelWriteMask=n.channelWriteMask);var s=t.rgbBlendState.blendMode!==n.rgbBlendState.blendMode||t.alphaBlendState.blendMode!==n.alphaBlendState.blendMode,o=t.rgbBlendState.blendSrcFactor!==n.rgbBlendState.blendSrcFactor||t.alphaBlendState.blendSrcFactor!==n.alphaBlendState.blendSrcFactor||t.rgbBlendState.blendDstFactor!==n.rgbBlendState.blendDstFactor||t.alphaBlendState.blendDstFactor!==n.alphaBlendState.blendDstFactor;(o||s)&&(x(t.rgbBlendState)&&x(t.alphaBlendState)?a.enableiOES(e,i.BLEND):x(n.rgbBlendState)&&x(n.alphaBlendState)&&a.disableiOES(e,i.BLEND)),s&&(a.blendEquationSeparateiOES(e,n.rgbBlendState.blendMode,n.alphaBlendState.blendMode),t.rgbBlendState.blendMode=n.rgbBlendState.blendMode,t.alphaBlendState.blendMode=n.alphaBlendState.blendMode),o&&(a.blendFuncSeparateiOES(e,n.rgbBlendState.blendSrcFactor,n.rgbBlendState.blendDstFactor,n.alphaBlendState.blendSrcFactor,n.alphaBlendState.blendDstFactor),t.rgbBlendState.blendSrcFactor=n.rgbBlendState.blendSrcFactor,t.alphaBlendState.blendSrcFactor=n.alphaBlendState.blendSrcFactor,t.rgbBlendState.blendDstFactor=n.rgbBlendState.blendDstFactor,t.alphaBlendState.blendDstFactor=n.alphaBlendState.blendDstFactor)},e.prototype.applyAttachmentState=function(e,t){var n=this.gl;e.channelWriteMask!==t.channelWriteMask&&(n.colorMask(!!(t.channelWriteMask&r.ChannelWriteMask.Red),!!(t.channelWriteMask&r.ChannelWriteMask.Green),!!(t.channelWriteMask&r.ChannelWriteMask.Blue),!!(t.channelWriteMask&r.ChannelWriteMask.Alpha)),e.channelWriteMask=t.channelWriteMask);var i=e.rgbBlendState.blendMode!==t.rgbBlendState.blendMode||e.alphaBlendState.blendMode!==t.alphaBlendState.blendMode,a=e.rgbBlendState.blendSrcFactor!==t.rgbBlendState.blendSrcFactor||e.alphaBlendState.blendSrcFactor!==t.alphaBlendState.blendSrcFactor||e.rgbBlendState.blendDstFactor!==t.rgbBlendState.blendDstFactor||e.alphaBlendState.blendDstFactor!==t.alphaBlendState.blendDstFactor;(a||i)&&(x(e.rgbBlendState)&&x(e.alphaBlendState)?n.enable(n.BLEND):x(t.rgbBlendState)&&x(t.alphaBlendState)&&n.disable(n.BLEND)),i&&(n.blendEquationSeparate(t.rgbBlendState.blendMode,t.alphaBlendState.blendMode),e.rgbBlendState.blendMode=t.rgbBlendState.blendMode,e.alphaBlendState.blendMode=t.alphaBlendState.blendMode),a&&(n.blendFuncSeparate(t.rgbBlendState.blendSrcFactor,t.rgbBlendState.blendDstFactor,t.alphaBlendState.blendSrcFactor,t.alphaBlendState.blendDstFactor),e.rgbBlendState.blendSrcFactor=t.rgbBlendState.blendSrcFactor,e.alphaBlendState.blendSrcFactor=t.alphaBlendState.blendSrcFactor,e.rgbBlendState.blendDstFactor=t.rgbBlendState.blendDstFactor,e.alphaBlendState.blendDstFactor=t.alphaBlendState.blendDstFactor)},e.prototype.setMegaState=function(e){var t=this.gl,n=this.currentMegaState;if(null!==this.OES_draw_buffers_indexed)for(var i=0;e.attachmentsState.length>i;i++)this.applyAttachmentStateIndexed(i,n.attachmentsState[0],e.attachmentsState[0]);else r.assert(1===e.attachmentsState.length),this.applyAttachmentState(n.attachmentsState[0],e.attachmentsState[0]);r.colorEqual(n.blendConstant,e.blendConstant)||(t.blendColor(e.blendConstant.r,e.blendConstant.g,e.blendConstant.b,e.blendConstant.a),r.colorCopy(n.blendConstant,e.blendConstant)),n.depthCompare!==e.depthCompare&&(t.depthFunc(e.depthCompare),n.depthCompare=e.depthCompare),n.depthWrite!==e.depthWrite&&(t.depthMask(e.depthWrite),n.depthWrite=e.depthWrite),n.stencilWrite!==e.stencilWrite&&(t.stencilMask(e.stencilWrite?255:0),n.stencilWrite=e.stencilWrite),n.stencilPassOp!==e.stencilPassOp&&(t.stencilOp(t.KEEP,t.KEEP,e.stencilPassOp),n.stencilPassOp=e.stencilPassOp),n.stencilRef===e.stencilRef&&n.stencilCompare===e.stencilCompare||(n.stencilCompare=e.stencilCompare,this.setStencilRef(e.stencilRef)),n.cullMode!==e.cullMode&&(n.cullMode===r.CullMode.None?t.enable(t.CULL_FACE):e.cullMode===r.CullMode.None&&t.disable(t.CULL_FACE),e.cullMode===r.CullMode.Back?t.cullFace(t.BACK):e.cullMode===r.CullMode.Front?t.cullFace(t.FRONT):e.cullMode===r.CullMode.FrontAndBack&&t.cullFace(t.FRONT_AND_BACK),n.cullMode=e.cullMode),n.frontFace!==e.frontFace&&(t.frontFace(e.frontFace),n.frontFace=e.frontFace),n.polygonOffset!==e.polygonOffset&&(e.polygonOffset?(t.polygonOffset(1,1),t.enable(t.POLYGON_OFFSET_FILL)):t.disable(t.POLYGON_OFFSET_FILL),n.polygonOffset=e.polygonOffset)},e.prototype.validatePipelineFormats=function(e){for(var t=0;this.currentColorAttachments.length>t;t++){var n=this.currentColorAttachments[t];null!==n&&r.assert(n.pixelFormat===e.colorAttachmentFormats[t])}null!==this.currentDepthStencilAttachment&&r.assert(this.currentDepthStencilAttachment.pixelFormat===e.depthStencilAttachmentFormat),-1!==this.currentSampleCount&&r.assert(this.currentSampleCount===e.sampleCount)},e.prototype.setPipeline=function(e){this.currentPipeline=e,this.validatePipelineFormats(this.currentPipeline),this.setMegaState(this.currentPipeline.megaState);var t=this.currentPipeline.program;if(this.useProgram(t),t.compileState===D.NeedsBind){var r=this.gl,n=t.gl_program,i=t.descriptor,a=L(i.preprocessedVert,/uniform (\w+) {([^]*?)}/g);if(E(r))for(var s=0;a.length>s;s++){var o=l(a[s],2),u=r.getUniformBlockIndex(n,o[1]);-1!==u&&4294967295!==u&&r.uniformBlockBinding(n,u,s)}var c=L(i.preprocessedVert,/^uniform .*sampler\S+ (\w+);\s* \/\/ BINDING=(\d+)$/gm);for(s=0;c.length>s;s++){var h=l(c[s],3),p=h[2],d=r.getUniformLocation(n,h[1]);r.uniform1i(d,parseInt(p))}t.compileState=D.ReadyToUse}},e.prototype.setInputState=function(e){this.currentInputState=e,null!==this.currentInputState?(r.assert(this.currentPipeline.inputLayout===this.currentInputState.inputLayout),this.bindVAO(this.currentInputState.vao)):(r.assert(null===this.currentPipeline.inputLayout),this.bindVAO(null))},e.prototype.setStencilRef=function(e){this.currentStencilRef!==e&&(this.currentStencilRef=e,this.applyStencil())},e.prototype.draw=function(e,t){this.gl.drawArrays(this.currentPipeline.drawMode,t,e),this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3)},e.prototype.drawIndexed=function(e,t){var n=this.gl,i=this.currentPipeline,a=this.currentInputState,s=r.assertExists(a.indexBufferByteOffset)+t*r.assertExists(a.indexBufferCompByteSize);n.drawElements(i.drawMode,e,r.assertExists(a.indexBufferType),s),this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3)},e.prototype.drawIndexedInstanced=function(e,t,n){var i,a=this.gl,s=this.currentPipeline,o=this.currentInputState,c=r.assertExists(o.indexBufferByteOffset)+t*r.assertExists(o.indexBufferCompByteSize),h=[s.drawMode,e,r.assertExists(o.indexBufferType),c,n];E(a)?a.drawElementsInstanced.apply(a,u([],l(h),!1)):(i=this.ANGLE_instanced_arrays).drawElementsInstancedANGLE.apply(i,u([],l(h),!1)),this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3*n)},e.prototype.beginOcclusionQuery=function(e){var t=this.gl;if(E(t)){var r=this.currentRenderPassDescriptor.occlusionQueryPool;t.beginQuery(r.gl_query_type,r.gl_query[e])}},e.prototype.endOcclusionQuery=function(e){var t=this.gl;E(t)&&t.endQuery(this.currentRenderPassDescriptor.occlusionQueryPool.gl_query_type)},e.prototype.beginDebugGroup=function(e){},e.prototype.endDebugGroup=function(){},e.prototype.pipelineQueryReady=function(e){return this.queryProgramReady(e.program)},e.prototype.pipelineForceReady=function(e){},e.prototype.endPass=function(){for(var e=this.gl,t=!1,n=0;this.currentColorAttachments.length>n;n++){var i=this.currentColorAttachments[n];if(null!==i){var a=this.currentColorResolveTos[n],s=!1;null!==a&&(r.assert(i.width===a.width&&i.height===a.height),r.assert(i.pixelFormat===a.pixelFormat),this.setScissorEnabled(!1),E(e)&&e.bindFramebuffer(e.READ_FRAMEBUFFER,this.resolveColorReadFramebuffer),this.resolveColorAttachmentsChanged&&E(e)&&this.bindFramebufferAttachment(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,i,this.currentColorAttachmentLevels[n]),s=!0,a===this.scTexture?e.bindFramebuffer(E(e)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,this.scPlatformFramebuffer):(e.bindFramebuffer(E(e)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,this.resolveColorDrawFramebuffer),this.resolveColorAttachmentsChanged&&e.framebufferTexture2D(E(e)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a.gl_texture,this.currentColorResolveToLevels[n])),E(e)?(e.blitFramebuffer(0,0,i.width,i.height,0,0,a.width,a.height,e.COLOR_BUFFER_BIT,e.LINEAR),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null)):this.submitBlitRenderPass(i,a),t=!0),this.currentRenderPassDescriptor.colorStore[n]||(s||(e.bindFramebuffer(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,this.resolveColorReadFramebuffer),this.resolveColorAttachmentsChanged&&this.bindFramebufferAttachment(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,e.COLOR_ATTACHMENT0,i,this.currentColorAttachmentLevels[n])),E(e)&&e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[e.COLOR_ATTACHMENT0])),e.bindFramebuffer(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,null)}}this.resolveColorAttachmentsChanged=!1;var o=this.currentDepthStencilAttachment;if(null!==o){var l=this.currentDepthStencilResolveTo;s=!1;null!==l&&(r.assert(o.width===l.width&&o.height===l.height),this.setScissorEnabled(!1),e.bindFramebuffer(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,this.resolveDepthStencilReadFramebuffer),e.bindFramebuffer(E(e)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,this.resolveDepthStencilDrawFramebuffer),this.resolveDepthStencilAttachmentsChanged&&(this.bindFramebufferDepthStencilAttachment(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,o),this.bindFramebufferDepthStencilAttachment(E(e)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,l)),s=!0,E(e)&&e.blitFramebuffer(0,0,o.width,o.height,0,0,l.width,l.height,e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(E(e)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,null),t=!0),this.currentRenderPassDescriptor.depthStencilStore||(s||(e.bindFramebuffer(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,this.resolveDepthStencilReadFramebuffer),this.resolveDepthStencilAttachmentsChanged&&this.bindFramebufferDepthStencilAttachment(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,o),s=!0),E(e)&&e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[e.DEPTH_STENCIL_ATTACHMENT])),s&&e.bindFramebuffer(E(e)?r.GL.READ_FRAMEBUFFER:r.GL.FRAMEBUFFER,null),this.resolveDepthStencilAttachmentsChanged=!1}t||e.bindFramebuffer(E(e)?r.GL.DRAW_FRAMEBUFFER:r.GL.FRAMEBUFFER,null)},e.prototype.setScissorEnabled=function(e){if(this.currentScissorEnabled!==e){var t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this.currentScissorEnabled=e}},e.prototype.applyStencil=function(){null!==this.currentStencilRef&&this.gl.stencilFunc(this.currentMegaState.stencilCompare,this.currentStencilRef,255)},e.prototype.getFallbackTexture=function(e){var t=e.gl_target;if(t===r.GL.TEXTURE_2D)return e.formatKind===r.SamplerFormatKind.Depth?this.fallbackTexture2DDepth:this.fallbackTexture2D;if(t===r.GL.TEXTURE_2D_ARRAY)return this.fallbackTexture2DArray;if(t===r.GL.TEXTURE_3D)return this.fallbackTexture3D;if(t===r.GL.TEXTURE_CUBE_MAP)return this.fallbackTextureCube;throw Error("whoops")},e.prototype.submitBlitRenderPass=function(e,t){if(!this.blitRenderPipeline){var n=r.makeDataBuffer(this,r.BufferUsage.VERTEX|r.BufferUsage.COPY_DST,new Float32Array([-4,-4,4,-4,0,4]).buffer),i=this.createInputLayout({vertexBufferDescriptors:[{byteStride:8,frequency:r.VertexBufferFrequency.PerVertex}],vertexAttributeDescriptors:[{format:r.Format.F32_RG,bufferIndex:0,bufferByteOffset:0,location:0}],indexBufferFormat:null}),s=[{numSamplers:1,numUniformBuffers:0}],o=this.createProgram(a(a({},r.preprocessProgramObj_GLSL(this,new r.CopyProgram)),{ensurePreprocessed:function(){},associate:function(){}}));this.blitInputState=this.createInputState(i,[{buffer:n,byteOffset:0}],null,o),this.blitRenderPipeline=this.createRenderPipeline({topology:r.PrimitiveTopology.Triangles,sampleCount:1,program:o,bindingLayouts:s,colorAttachmentFormats:[r.Format.U8_RGBA_RT],depthStencilAttachmentFormat:null,inputLayout:i,megaStateDescriptor:this.currentMegaState}),this.blitBindings=this.createBindings({bindingLayout:s[0],samplerBindings:[{sampler:null,texture:e.texture,lateBinding:null}],uniformBufferBindings:[]}),o.setUniforms({u_Texture:e})}var l=this.currentRenderPassDescriptor;this.currentRenderPassDescriptor=null,this.inBlitRenderPass=!0;var u=this.createRenderPass({colorAttachment:[e],colorResolveToLevel:[0],colorResolveTo:[t],colorClearColor:[r.TransparentWhite],colorStore:[!0],colorAttachmentLevel:[0],depthStencilAttachment:null,depthStencilResolveTo:null,depthStencilStore:!0,depthClearValue:"load",stencilClearValue:"load",occlusionQueryPool:null}),c=this.getCanvas(),h=c.width,p=c.height;u.setPipeline(this.blitRenderPipeline),u.setBindings(0,this.blitBindings,[0]),u.setInputState(this.blitInputState),u.setViewport(0,0,h,p),this.gl.disable(this.gl.BLEND),u.draw(3,0),this.gl.enable(this.gl.BLEND),this.currentRenderPassDescriptor=l,this.inBlitRenderPass=!1},e}(),K=function(){function e(e){this.pluginOptions=e}return e.prototype.createSwapChain=function(e){return s(this,void 0,void 0,(function(){var t,r,n;return o(this,(function(i){return t={antialias:!1,preserveDrawingBuffer:!1,stencil:!0,premultipliedAlpha:!0},this.handleContextEvents(e),(r=this.pluginOptions.targets).includes("webgl2")&&(n=e.getContext("webgl2",t)||e.getContext("experimental-webgl2",t)),!n&&r.includes("webgl1")&&(n=e.getContext("webgl",t)||e.getContext("experimental-webgl",t)),[2,new z(n,{shaderDebug:!0,trackResources:!0})]}))}))},e.prototype.handleContextEvents=function(e){var t=this.pluginOptions,r=t.onContextLost,n=t.onContextRestored,i=t.onContextCreationError;i&&e.addEventListener("webglcontextcreationerror",i,!1),r&&e.addEventListener("webglcontextlost",r,!1),n&&e.addEventListener("webglcontextrestored",n,!1)},e}(),j=function(e){function t(t){var r=e.call(this)||this;return r.options=t,r.name="webgl-device",r}return i(t,e),t.prototype.init=function(){this.context.deviceContribution=new K(a({},this.options))},t.prototype.destroy=function(){delete this.context.deviceContribution},t}(t.AbstractRendererPlugin);e.Plugin=j}));
//# sourceMappingURL=index.umd.min.js.map
