!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@antv/g-lite")):"function"==typeof define&&define.amd?define(["exports","@antv/g-lite"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).G=t.G||{},t.G.ImageLoader={}),t.window.G)}(this,(function(t,e){"use strict";var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},n(t,e)};var r="undefined"!=typeof Float32Array?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var a={}.toString,o=function(t,e){return a.call(t)==="[object "+e+"]"},i=function(t){return o(t,"String")},c=function(){function t(t){this.canvasConfig=t,this.imageCache={},this.gradientCache={},this.patternCache={}}return t.prototype.getImageSync=function(t,e){return this.imageCache[t]?e&&e():this.getOrCreateImage(t).then((function(){e&&e()})),this.imageCache[t]},t.prototype.getOrCreateImage=function(t){var n=this;if(this.imageCache[t])return Promise.resolve(this.imageCache[t]);var r=this.canvasConfig.createImage;return new Promise((function(a,o){var i;r?i=r(t):e.isBrowser&&(i=new window.Image),i&&(i.onload=function(){n.imageCache[t]=i,a(i)},i.onerror=function(t){o(t)},i.crossOrigin="Anonymous",i.src=t)}))},t.prototype.getOrCreatePatternSync=function(t,n,a,o,c){var u=this.generatePatternKey(t);if(u&&this.patternCache[u])return this.patternCache[u];var s,f=t.image,d=t.repetition,p=t.transform,g=!1;i(f)?s=this.getImageSync(f,c):a?(s=a,g=!0):s=f;var l,h=s&&n.createPattern(s,d);if(h){var y=void 0;y=p?e.parsedTransformToMat4(e.parseTransform(p),new e.DisplayObject({})):function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}((l=new r(16),r!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=0,l[12]=0,l[13]=0,l[14]=0),l[0]=1,l[5]=1,l[10]=1,l[15]=1,l)),g&&function(t,e,n){var r=n[0],a=n[1],o=n[2];t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*a,t[5]=e[5]*a,t[6]=e[6]*a,t[7]=e[7]*a,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(y,y,[1/o,1/o,1]),h.setTransform({a:y[0],b:y[1],c:y[4],d:y[5],e:y[12],f:y[13]})}return u&&h&&(this.patternCache[u]=h),h},t.prototype.getOrCreateGradient=function(t,n){var r=this.generateGradientKey(t),a=t.type,o=t.steps,i=t.width,c=t.height,u=t.cx,s=t.cy,f=t.size;if(this.gradientCache[r])return this.gradientCache[r];var d=null;if(a===e.GradientType.LinearGradient){var p=e.computeLinearGradient(i,c,t.angle);d=n.createLinearGradient(p.x1,p.y1,p.x2,p.y2)}else if(a===e.GradientType.RadialGradient){var g=e.computeRadialGradient(i,c,u,s,f),l=g.x,h=g.y;d=n.createRadialGradient(l,h,0,l,h,g.r)}return d&&(o.forEach((function(t){var n=t.offset;n.unit===e.UnitType.kPercentage&&(null==d||d.addColorStop(n.value/100,""+t.color))})),this.gradientCache[r]=d),this.gradientCache[r]},t.prototype.generateGradientKey=function(t){var e=t.width,n=t.height,r=t.steps,a=t.angle,o=t.cx,i=t.cy,c=t.size;return"gradient-".concat(t.type,"-").concat((null==a?void 0:""+a)||0,"-").concat((null==o?void 0:""+o)||0,"-").concat((null==i?void 0:""+i)||0,"-").concat((null==c?void 0:""+c)||0,"-").concat(e,"-").concat(n,"-").concat(r.map((function(t){var e=t.color;return"".concat(t.offset).concat(e)})).join("-"))},t.prototype.generatePatternKey=function(t){var e=t.image,n=t.repetition;return i(e)?"pattern-".concat(e,"-").concat(n):"rect"===e.nodeName?"pattern-".concat(e.entity,"-").concat(n):void 0},t}(),u=function(){function t(){}return t.prototype.apply=function(n){var r=n.renderingService,a=n.imagePool,o=n.renderingContext.root.ownerDocument.defaultView,c=function(t){var n=t.target;if(n.nodeName===e.Shape.IMAGE){var o=n.attributes.img;i(o)&&a.getImageSync(o,(function(){n.renderable.dirty=!0,r.dirtify()}))}},u=function(t){var n=t.target,o=t.newValue;n.nodeName===e.Shape.IMAGE&&"img"===t.attrName&&i(o)&&a.getOrCreateImage(o).then((function(){n.renderable.dirty=!0,r.dirtify()}))};r.hooks.init.tap(t.tag,(function(){o.addEventListener(e.ElementEvent.MOUNTED,c),o.addEventListener(e.ElementEvent.ATTR_MODIFIED,u)})),r.hooks.destroy.tap(t.tag,(function(){o.removeEventListener(e.ElementEvent.MOUNTED,c),o.removeEventListener(e.ElementEvent.ATTR_MODIFIED,u)}))},t.tag="LoadImage",t}(),s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="image-loader",e}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+e+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.init=function(){this.context.imagePool=new c(this.context.config),this.addRenderingPlugin(new u)},e.prototype.destroy=function(){this.removeAllRenderingPlugins()},e}(e.AbstractRendererPlugin);t.ImagePool=c,t.Plugin=s}));
//# sourceMappingURL=index.umd.min.js.map
